---
title: "base-R vs. dplyr vs. data.table"
subtitle: "Data Munging in Memory"
author: "Mario Annau, Rainer St√ºtz, Florian Schwendinger"
date: "12/12/2017"
output: ioslides_presentation
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = FALSE)

library(microbenchmark)
library(ggplot2)
source("functions.R")

# Determine 10 most traded BTC pairs
# f <- h5file("data/poloniex.h5", "r")
# sort(sapply(list.groups(f), function(x) f[[sprintf("%s/trades", x)]]$dims[1] ), decreasing = TRUE)[1:10]
```

# Introduction


## Data Set

<!-- TODO(mario) -->

- Tick data from Poloniex from ... to ...
- Obtained through rest API at ...
- ...

## Benchmark Time Series Use Cases

1. Aggregate OHCL 1 minute bars for selected pairs (11) based on Poloniex data

```{r}
mostliquid <- get_most_liquid()

ggplot(mostliquid) + 
  geom_bar(aes(x = CCY, y = TICKS, fill = Cross), stat = "identity") + 
  theme(axis.text.x = element_text(angle = 90, hjust = 1)) + 
  ylab("Million Ticks") + xlab("")
```

## Benchmark Time Series Use Cases

2. Join aggregated pairs based on Datetime

2.1 Calculate regarding USD Cross rates based on USDT_BTC (not-benchmarked)

3. Filter resulting table (e.g. 12.12.-31.12.2016)

3.1 Plot results (not-benchmarked)


## Packages Used

- **base**-R (Florian)
- **dplyr** (Rainer)
- **data.table** (Mario)

*Optional*

- **RSQLite** memory mapped (Florian)
- Python **pandas** (Mario)

# base R

## Introduction

<!-- TODO(florian) -->

# dplyr

## Introduction


<!-- TODO(rainer) -->

# data.table

## Introduction

- Created by Matt Dowle in 
- Most downloaded package according to ...
- High performance version of data.frame

## Introduction (2)

![Video from UseR! 2014](img/data_table_talk.png)

Video from UseR! 2014: https://www.youtube.com/watch?v=qLrdYhizEMg


## Why is data.table fast?

- Internalize/Optimize common functions (e.g. GForce)
- Efficient sorting functions

## data.table Syntax

```{r, echo=TRUE, eval=FALSE}
library(data.table)
DT[i, j, by]
```

- i: On which rows (WHERE)
- j: What to do (SELECT)
- by: Grouped by what? (GROUP BY)

## 1. Calculate USD cross rates on Poloniex

```{r, eval = FALSE, echo=TRUE}
dat <- data.table(dat) # Convert to data.table
dat[, Index := index]
setkey(dat, Index) # Set index key
setkey(dat, Date) # do the ordering implicitly using key

# Aggregate
dat[, .(Open = data.table::first(Price), 
       High = max(Price), 
       Low = min(Price), 
       Close = data.table::last(Price), 
       Volume = sum(Volume)), by = Index]
```

## 1. Calculate USD cross rates on Poloniex Caveats

- `setkey(dat, Index)` does not bring any performance gains
- In order for GForce to work, do NOT use `first` instead of `data.table::first` (function matching)

```{r, eval = FALSE}
dat[, .(Open = data.table::first(Price), 
          High = max(Price), 
          Low = min(Price), 
          Close = data.table::last(Price), 
          Volume = sum(Volume)), by = Index]
```


## 1. Benchmark results

```{r, echo=FALSE, eval=TRUE}
load("data/bench_datatable_1.rda")
ggplot(bench_datatable_1) + geom_bar(aes(x = Method, y = value, fill = Var1), stat = "sum")
```

## 2. Join aggregated pairs based on Datetime

```{r, echo=TRUE, eval = FALSE}
Reduce(function(...) 
  merge(..., by = "Index", all = TRUE), 
  dat.all.hashkey)
```

## 2. Benchmark results

```{r, echo=FALSE, eval=TRUE}
load(file = "data/bench_datatable_2.rda")
# TODO(mario): modify plot
autoplot(bench_datatable_2) 
```

## 2.1 Calculate Cross Rates in USD

```{r, echo = TRUE, eval = FALSE}
dat.outer.join <- Reduce(merge, dat.all.hashkey, by = "Index", all = TRUE)
cols <- !names(dat.outer.join) %in% c("Index", "USDT_BTC")
cols2 <- rep("USDT_BTC", length(which(cols)))
dt <- data.table(dat.outer.join[, "Index"], dat.outer.join[, ..cols] * dat.outer.join[, ..cols2])
```


## 3. Filter resulting table

Filter resulting table from 12.12.-31.12.2016

```{r, echo = TRUE, eval = FALSE}
dt <- zoo::na.locf(dt)
sset <- dt[Index >= as.POSIXct("2016-12-12") & Index <= as.POSIXct("2016-12-31")]
```

## 3. Benchmark results

<!-- TODO(mario) -->

## 3.1 Plot results

```{r, echo = TRUE, eval = FALSE}
cols <- 2:ncol(dt)
tsfilter <- zoo(dt[, ..cols], order.by = dt[, "Index"])
plot(tsfilter)
```


## Summary data.table

<!-- TODO(mario) -->

## Benchmark Summary data.table

<!-- TODO(mario) -->

# Conclusion



<!--
quotes.usd <- grep("USDT_", allquotes, value = TRUE, fixed = TRUE)

ccy.usd <- sapply(strsplit(quotes.usd, "_"), function(x) x[2])
ccy.btc <- sapply(strsplit(quotes.btc, "_"), function(x) x[2])


kraken <- h5file("data/kraken.h5", mode = "r")



btcxrp <- load_data("data/poloniex.h5", "BTC_XRP", folder = "POLONIEX")[[1]]
index <- calc_index(btcxrp)
mb <- microbenchmark(
  agg_ohcl_base_r(btcxrp, index),
  agg_ohcl_dplyr(btcxrp, index),
  agg_ohcl_data_table(btcxrp, index), 
  times = 1)
knitr::kable(mb)

-->

